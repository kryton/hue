{"body":"<div><div id=\"tablesample\"><div class=\"hue-doc-title\">TABLESAMPLE Clause</div><div><p>\n      Specify the <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause in cases where you need\n      to explore the data distribution within the table, the table is very large,\n      and it is impractical or unnecessary to process all the data from the table\n      or selected partitions.\n    </p><p>\n      The clause makes the query process a randomized set of data files from the\n      table, so that the total volume of data is greater than or equal to the specified\n      percentage of data bytes within that table. (Or the data bytes within the set of\n      partitions that remain after partition pruning is performed.)\n    </p><p id=\"syntax_blurb\"><b>Syntax:</b></p><div class=\"hue-doc-codeblock\"><span class=\"hue-doc-ph\">TABLESAMPLE SYSTEM(<span class=\"hue-doc-varname\">percentage</span>) [REPEATABLE(<span class=\"hue-doc-varname\">seed</span>)]</span></div><p>\n      The <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause comes immediately after a table name or table alias.\n    </p><p>\n      The <span class=\"hue-doc-codeph\">SYSTEM</span> keyword represents the sampling method. Currently,\n      Impala only supports a single sampling method named <span class=\"hue-doc-codeph\">SYSTEM</span>.\n    </p><p>\n      The <span class=\"hue-doc-varname\">percentage</span> argument is an integer literal from 0 to 100.\n      A percentage of 0 produces an empty result set for a particular table reference,\n      while a percentage of 100 uses the entire contents. Because the sampling works by\n      selecting a random set of data files, the proportion of sampled data from the\n      table may be greater than the specified percentage, based on the number and sizes\n      of the underlying data files. See the usage notes for details.\n    </p><p>\n      The optional <span class=\"hue-doc-codeph\">REPEATABLE</span> keyword lets you specify an arbitrary\n      positive integer seed value that ensures that when the query is run again, the\n      sampling selects the same set of data files each time. <span class=\"hue-doc-codeph\">REPEATABLE</span>\n      does not have a default value. If you omit the <span class=\"hue-doc-codeph\">REPEATABLE</span> keyword,\n      the random seed is derived from the current time.\n    </p><p id=\"added_in_290\"><b>Added in:</b>Impala 2.9.0</p><p>\n      See <a class=\"hue-doc-internal-link\" href=\"javascript:void(0);\" data-doc-ref=\"topics/impala_compute_stats.xml\" data-doc-anchor-id=\"compute_stats\">COMPUTE STATS Statement</a> for the\n        <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause used in the <span class=\"hue-doc-codeph\">COMPUTE\n        STATS</span> statement.\n    </p><p id=\"usage_notes_blurb\"><b>Usage notes:</b></p><p>\n      You might use this clause with aggregation queries, such as finding\n      the approximate average, minimum, or maximum where exact precision\n      is not required. You can use these findings to plan the most effective\n      strategy for constructing queries against the full table or designing\n      a partitioning strategy for the data.\n    </p><p>\n      Some other database systems have a <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause.\n      The Impala syntax for this clause is modeled on the syntax for popular\n      relational databases, not the Hive <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause.\n      For example, there is no <span class=\"hue-doc-codeph\">BUCKETS</span> keyword as in HiveQL.\n    </p><p>\n      The precision of the <span class=\"hue-doc-varname\">percentage</span> threshold depends on\n      the number and sizes of the underlying data files. Impala brings in\n      additional data files, one at a time, until the number of bytes exceeds\n      the specified percentage based on the total number of bytes for the\n      entire set of table data. The precision of the percentage threshold is higher\n      when the table contains many data files with consistent sizes. See the\n      code listings later in this section for examples.\n    </p><p>\n      When you estimate characteristics of the data distribution based on sampling\n      a percentage of the table data, be aware that the data might be unevenly distributed\n      between different files. Do not assume that the percentage figure reflects the\n      percentage of rows in the table. For example, one file might contain all blank values\n      for a <span class=\"hue-doc-codeph\">STRING</span> column, while another file contains long strings\n      in that column; therefore, one file could contain many more rows than another.\n      Likewise, a table created with the <span class=\"hue-doc-codeph\">SORT BY</span> clause might\n      contain narrow ranges of values for the sort columns, making it impractical to\n      extrapolate the number of distinct values for those columns based on sampling\n      only some of the data files.\n    </p><p>\n      Because a sample of the table data might not contain all values for a particular\n      column, if the <span class=\"hue-doc-codeph\">TABLESAMPLE</span> is used in a join query, the\n      key relationships between the tables might produce incomplete result sets\n      compared to joins using all the table data. For example, if you join 50%\n      of table A with 50% of table B, some values in the join columns might\n      not match between the two tables, even though overall there is a 1:1\n      relationship between the tables.\n    </p><p>\n      The <span class=\"hue-doc-codeph\">REPEATABLE</span> keyword makes identical queries use a\n      consistent set of data files when the query is repeated. You specify an\n      arbitrary integer key that acts as a seed value when Impala randomly\n      selects the set of data files to use in the query. This technique\n      lets you verify correctness, examine performance, and so on for queries\n      using the <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause without the sampled data\n      being different each time. The repeatable aspect is reset (that is, the\n      set of selected data files may change) any time the contents of the table\n      change. The statements or operations that can make sampling results\n      non-repeatable are:\n    </p><ul><li><span class=\"hue-doc-codeph\">INSERT</span>.\n      </li><li><span class=\"hue-doc-codeph\">TRUNCATE TABLE</span>.\n      </li><li><span class=\"hue-doc-codeph\">LOAD DATA</span>.\n      </li><li><span class=\"hue-doc-codeph\">REFRESH</span> or <span class=\"hue-doc-codeph\">INVALIDATE METADATA</span>\n        after files are added or removed by a non-Impala mechanism.\n      </li><li/></ul><p>\n      This clause is similar in some ways to the <span class=\"hue-doc-codeph\">LIMIT</span> clause,\n      because both serve to limit the size of the intermediate data and final\n      result set. <span class=\"hue-doc-codeph\">LIMIT 0</span> is more efficient than\n      <span class=\"hue-doc-codeph\">TABLESAMPLE SYSTEM(0)</span> for verifying that a query can execute\n      without producing any results. <span class=\"hue-doc-codeph\">TABLESAMPLE SYSTEM(<span class=\"hue-doc-varname\">n</span>)</span>\n      often makes query processing more efficient than using a <span class=\"hue-doc-codeph\">LIMIT</span> clause\n      by itself, because all phases of query execution use less data overall.\n      If the intent is to retrieve some representative values from the table\n      in an efficient way, you might combine <span class=\"hue-doc-codeph\">TABLESAMPLE</span>,\n      <span class=\"hue-doc-codeph\">ORDER BY</span>, and <span class=\"hue-doc-codeph\">LIMIT</span> clauses within a single query.\n    </p><p id=\"partitioning_blurb\"><b>Partitioning:</b></p><p>\n      When you query a partitioned table, any partition pruning happens\n      before Impala selects the data files to sample. For example, in a\n      table partitioned by year, a query with <span class=\"hue-doc-codeph\">WHERE year = 2017</span>\n      and a <span class=\"hue-doc-codeph\">TABLESAMPLE SYSTEM(10)</span> clause would sample\n      data files representing at least 10% of the bytes present in the\n      2017 partition.\n    </p><p id=\"s3_blurb\"><b>Amazon S3 considerations:</b></p><p>\n      This clause applies to S3 tables the same way as tables\n      with data files stored on HDFS.\n    </p><p id=\"adls_blurb\"><b>ADLS considerations:</b></p><p>\n      This clause applies to ADLS tables the same way as tables\n      with data files stored on HDFS.\n    </p><p id=\"kudu_blurb\"><b>Kudu considerations:</b></p><p>\n      This clause does not apply to Kudu tables.\n    </p><p id=\"hbase_blurb\"><b>HBase considerations:</b></p><p>\n      This clause does not apply to HBase tables.\n    </p><p id=\"performance_blurb\"><b>Performance considerations:</b></p><p>\n      From a performance perspective, the <span class=\"hue-doc-codeph\">TABLESAMPLE</span>\n      clause is especially valuable for exploratory queries on\n      text, Avro, or other file formats other than Parquet. Text-based\n      or row-oriented file formats must process substantial amounts of\n      redundant data for queries that derive aggregate results such as\n      <span class=\"hue-doc-codeph\">MAX()</span>, <span class=\"hue-doc-codeph\">MIN()</span>, or <span class=\"hue-doc-codeph\">AVG()</span>\n      for a single column. Therefore, you might use <span class=\"hue-doc-codeph\">TABLESAMPLE</span>\n      early in the ETL pipeline, when data is still in raw text format\n      and has not been converted to Parquet or moved into a partitioned\n      table.\n    </p><p id=\"restrictions_blurb\"><b>Restrictions:</b></p><p>\n      This clause applies only to tables that use a storage layer\n      with underlying raw data files, such as HDFS, Amazon S3,\n      or Microsoft ADLS.\n    </p><p>\n      This clause does not apply to table references that represent views.\n      A query that applies the <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause to a\n      view or a subquery fails with a semantic error.\n    </p><p>\n      Because the sampling works at the level of entire data files, it\n      is by nature coarse-grained. It is possible to specify a small\n      sample percentage but still process a substantial portion of the\n      table data if the table contains relatively few data files, if\n      each data file is very large, or if the data files vary substantially\n      in size. Be sure that you understand the data distribution and physical\n      file layout so that you can verify if the results are suitable for\n      extrapolation. For example, if the table contains only a single data file,\n      the <q>sample</q> will consist of all the table data regardless of\n      the percentage you specify. If the table contains data files of\n      1 GiB, 1 GiB, and 1 KiB, when you specify a sampling percentage of\n      50 you would either process slightly more than 50% of the table\n      (1 GiB + 1 KiB) or almost the entire table (1 GiB + 1 GiB),\n      depending on which data files were selected for sampling.\n    </p><p>\n      If data files are added by a non-Impala mechanism, and the\n      table metadata is not updated by a <span class=\"hue-doc-codeph\">REFRESH</span>\n      or <span class=\"hue-doc-codeph\">INVALIDATE METADATA</span> statement, the\n      <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause does not consider those\n      new files when computing the number of bytes in the table\n      or selecting which files to sample.\n    </p><p>\n      If data files are removed by a non-Impala mechanism, and the\n      table metadata is not updated by a <span class=\"hue-doc-codeph\">REFRESH</span>\n      or <span class=\"hue-doc-codeph\">INVALIDATE METADATA</span> statement, the\n      query fails if the <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause\n      attempts to reference any of the missing files.\n    </p><p id=\"example_blurb\"><b>Examples:</b></p><p>\n      The following examples demonstrate the <span class=\"hue-doc-codeph\">TABLESAMPLE</span> clause.\n      These examples intentionally use very small data sets to illustrate how\n      the number of files, size of each file, and overall size of data in the table\n      interact with the percentage specified in the clause.\n    </p><p>\n      These examples use an unpartitioned table, containing several files of roughly\n      the same size:\n    </p><div class=\"hue-doc-codeblock\">create table sample_demo (x int, s string);\n\ninsert into sample_demo values (1, 'one');\ninsert into sample_demo values (2, 'two');\ninsert into sample_demo values (3, 'three');\ninsert into sample_demo values (4, 'four');\ninsert into sample_demo values (5, 'five');\n\nshow files in sample_demo;\n+---------------------+------+-----------+\n| Path                | Size | Partition |\n+---------------------+------+-----------+\n| 991213608_data.0.   | 7B   |           |\n| 982196806_data.0.   | 6B   |           |\n| _2122096884_data.0. | 8B   |           |\n| _586325431_data.0.  | 6B   |           |\n| 1894746258_data.0.  | 7B   |           |\n+---------------------+------+-----------+\n\nshow table stats sample_demo;\n+-------+--------+------+--------+-------------------------+\n| #Rows | #Files | Size | Format | Location                |\n+-------+--------+------+--------+-------------------------+\n| -1    | 5      | 34B  | TEXT   | /tsample.db/sample_demo |\n+-------+--------+------+--------+-------------------------+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      A query that samples 50% of the table must process at least\n      17 bytes of data. Based on the sizes of the data files,\n      we can predict that each such query uses 3 arbitrary files.\n      Any 1 or 2 files are not enough to reach 50% of the total\n      data in the table (34 bytes), so the query adds more files\n      until it passes the 50% threshold:\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\nselect distinct x from sample_demo tablesample system(50);\n+---+\n| x |\n+---+\n| 4 |\n| 1 |\n| 5 |\n+---+\n\nselect distinct x from sample_demo tablesample system(50);\n+---+\n| x |\n+---+\n| 5 |\n| 4 |\n| 2 |\n+---+\n\nselect distinct x from sample_demo tablesample system(50);\n+---+\n| x |\n+---+\n| 5 |\n| 3 |\n| 2 |\n+---+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      To help run reproducible experiments, the &lt;codeph&gt;REPEATABLE&lt;/codeph&gt;\n      clause causes Impala to choose the same set of files for each query.\n      Although the data set being considered is deterministic, the order\n      of results varies (in the absence of an &lt;codeph&gt;ORDER BY&lt;/codeph&gt;\n      clause) because of the way distributed queries are processed:\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\nselect distinct x from sample_demo\n  tablesample system(50) repeatable (12345);\n+---+\n| x |\n+---+\n| 3 |\n| 2 |\n| 1 |\n+---+\n\nselect distinct x from sample_demo\n  tablesample system(50) repeatable (12345);\n+---+\n| x |\n+---+\n| 2 |\n| 1 |\n| 3 |\n+---+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      The following examples show how uneven data distribution affects\n      which data is sampled. Adding another data file containing a long\n      string value changes the threshold for 50% of the total data in\n      the table:\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\ninsert into sample_demo values (1000, 'Boyhood is the longest time in li\nfe for a boy. The last term of the school-year is made of decades, not o\nf weeks, and living through them is like waiting for the millennium. Boo\nth Tarkington');\n\nshow files in sample_demo;\n+---------------------+------+-----------+\n| Path                | Size | Partition |\n+---------------------+------+-----------+\n| 991213608_data.0.   | 7B   |           |\n| 982196806_data.0.   | 6B   |           |\n| _253317650_data.0.  | 196B |           |\n| _2122096884_data.0. | 8B   |           |\n| _586325431_data.0.  | 6B   |           |\n| 1894746258_data.0.  | 7B   |           |\n+---------------------+------+-----------+\n\nshow table stats sample_demo;\n+-------+--------+------+--------+-------------------------+\n| #Rows | #Files | Size | Format | Location                |\n+-------+--------+------+--------+-------------------------+\n| -1    | 6      | 230B | TEXT   | /tsample.db/sample_demo |\n+-------+--------+------+--------+-------------------------+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      Even though the queries do not refer to the &lt;codeph&gt;S&lt;/codeph&gt;\n      column containing the long value, all the sampling queries include\n      the data file containing the column value &lt;codeph&gt;X=1000&lt;/codeph&gt;,\n      because the query cannot reach the 50% threshold (115 bytes) without\n      including that file. The large file might be considered first, in which\n      case it is the only file processed by the query. Or an arbitrary\n      set of other files might be considered first.\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\nselect distinct x from sample_demo tablesample system(50);\n+------+\n| x    |\n+------+\n| 1000 |\n| 3    |\n| 1    |\n+------+\n\nselect distinct x from sample_demo tablesample system(50);\n+------+\n| x    |\n+------+\n| 1000 |\n+------+\n\nselect distinct x from sample_demo tablesample system(50);\n+------+\n| x    |\n+------+\n| 1000 |\n| 4    |\n| 2    |\n| 1    |\n+------+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      The following examples demonstrate how the &lt;codeph&gt;TABLESAMPLE&lt;/codeph&gt;\n      clause interacts with other table aspects, such as partitioning and file\n      format:\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\ncreate table sample_demo_partitions (x int, s string) partitioned by (n int) stored as parquet;\n\ninsert into sample_demo_partitions partition (n = 1) select * from sample_demo;\ninsert into sample_demo_partitions partition (n = 2) select * from sample_demo;\ninsert into sample_demo_partitions partition (n = 3) select * from sample_demo;\n\nshow files in sample_demo_partitions;\n+--------------------------------+--------+-----------+\n| Path                           | Size   | Partition |\n+--------------------------------+--------+-----------+\n| 000000_364262785_data.0.parq   | 1.24KB | n=1       |\n| 000001_973526736_data.0.parq   | 566B   | n=1       |\n| 0000000_1300598134_data.0.parq | 1.24KB | n=2       |\n| 0000001_689099063_data.0.parq  | 568B   | n=2       |\n| 0000000_1861371709_data.0.parq | 1.24KB | n=3       |\n| 0000001_1065507912_data.0.parq | 566B   | n=3       |\n+--------------------------------+--------+-----------+\n\nshow table stats tablesample_demo_partitioned;\n+-------+-------+--------+--------+---------+----------------------------------------------+\n| n     | #Rows | #Files | Size   | Format  | Location                                     |\n+-------+-------+--------+--------+---------+----------------------------------------------+\n| 1     | -1    | 2      | 1.79KB | PARQUET | /tsample.db/tablesample_demo_partitioned/n=1 |\n| 2     | -1    | 2      | 1.80KB | PARQUET | /tsample.db/tablesample_demo_partitioned/n=2 |\n| 3     | -1    | 2      | 1.79KB | PARQUET | /tsample.db/tablesample_demo_partitioned/n=3 |\n| Total | -1    | 6      | 5.39KB |         |                                              |\n+-------+-------+--------+--------+---------+----------------------------------------------+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      If the query does not involve any partition pruning, the\n      sampling applies to the data volume of the entire table:\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\n-- 18 rows total.\nselect count(*) from sample_demo_partitions;\n+----------+\n| count(*) |\n+----------+\n| 18       |\n+----------+\n\n-- The number of rows per data file is not\n-- perfectly balanced, therefore the count\n-- is different depending on which set of files\n-- is considered.\nselect count(*) from sample_demo_partitions\n  tablesample system(75);\n+----------+\n| count(*) |\n+----------+\n| 14       |\n+----------+\n\nselect count(*) from sample_demo_partitions\n  tablesample system(75);\n+----------+\n| count(*) |\n+----------+\n| 16       |\n+----------+\n&lt;/codeblock&gt;\n\n    &lt;p&gt;\n      If the query only processes certain partitions,\n      the query computes the sampling threshold based on\n      the data size and set of files only from the\n      relevant partitions:\n    &lt;/p&gt;\n\n&lt;codeblock&gt;&lt;![CDATA[\nselect count(*) from sample_demo_partitions\n  tablesample system(50) where n = 1;\n+----------+\n| count(*) |\n+----------+\n| 6        |\n+----------+\n\nselect count(*) from sample_demo_partitions\n  tablesample system(50) where n = 1;\n+----------+\n| count(*) |\n+----------+\n| 2        |\n+----------+\n</div><p id=\"related_info\"><b>Related information:</b></p><p><a class=\"hue-doc-internal-link\" href=\"javascript:void(0);\" data-doc-ref=\"topics/impala_select.xml\" data-doc-anchor-id=\"select\">SELECT Statement</a></p></div></div></div>","title":"TABLESAMPLE Clause"}